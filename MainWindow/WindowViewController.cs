// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Diagnostics;
using AppKit;
using Foundation;
using MacGallery.Extensions;
using MacGallery.ThumbnailGrid;
using MacGallery.ThumbnailGrid.Models;
using ObjCRuntime;

namespace MacGallery.MainWindow
{
    public partial class WindowViewController : NSViewController
    {
        private ThumbnailGridViewController? gridViewController;

        public static class Notifications
        {
            public static readonly NSString ShowProgressBar = new NSString(nameof(ShowProgressBar));
        }

        public override void ViewDidLoad()
        {
            base.ViewDidLoad();
            ShowProgress(false);

            gridViewController = Storyboard.CreateController<ThumbnailGridViewController>();
            gridViewController.ThumbnailDoubleClicked += IconViewController_ThumbnailDoubleClicked;

            SetupObservers();
        }

        private void IconViewController_ThumbnailDoubleClicked(ThumbnailModel? thumbnail)
        {
            Debug.WriteLine(nameof(IconViewController_ThumbnailDoubleClicked));
            ShowImageInFullScreenWindow(thumbnail);
        }

        private void ShowImageInFullScreenWindow(ThumbnailModel? thumbnailModel)
        {
            var imageWindowController = Storyboard.CreateWindow<ImageWindowController>();
            var imageWindow = imageWindowController.Window;
            imageWindow.ToggleFullScreen(this);

            if (imageWindow.ContentViewController is ImageViewController imageViewController)
            {
                imageViewController.SetCurrentThumbnail(thumbnailModel);
            }
        }

        private void ShowProgress(bool show)
        {
            progressBar.Hidden = !show;
            if (progressBar.Hidden)
            {
                progressBar.StopAnimation(this);
            }
            else
            {
                progressBar.StartAnimation(this);
            }
        }

        private NSUrl? PromptForWorkingDirectory()
        {
            var openPanel = NSOpenPanel.OpenPanel;
            openPanel.Message = "Choose directory";
            openPanel.Title = "Choose";
            openPanel.AllowedFileTypes = new[] { "none" };
            openPanel.AllowsOtherFileTypes = false;
            openPanel.CanChooseFiles = false;
            openPanel.CanChooseDirectories = true;

            return openPanel.Show() switch
            {
                NSModalResponse.OK => openPanel.DirectoryUrl,
                _ => null
            };
        }

        private void EmbedChildViewController(NSViewController? childViewController)
        {
            if (childViewController is null)
            {
                return;
            }

            foreach (var view in containerView.Subviews)
            {
                view.RemoveFromSuperview();
            }

            childViewController.View.Frame = containerView.Bounds;
            containerView.AddSubview(childViewController.View);
        }

        partial void BrowseToolbarAction(NSObject sender)
        {
            Debug.WriteLine(nameof(BrowseToolbarAction));

            var workingDir = PromptForWorkingDirectory();

            try
            {
                gridViewController?.SetWorkingDirectoryUrl(workingDir);
                EmbedChildViewController(gridViewController);
            }
            catch (Exception ex)
            {
                Debug.WriteLine(ex);
            }
        }

        public static void SendShowProgress()
        {
            Debug.WriteLine(nameof(SendShowProgress));
            NSNotificationCenter.DefaultCenter.PostNotificationName(Notifications.ShowProgressBar, NSNumber.FromBoolean(true));
        }

        public static void SendHideProgress()
        {
            Debug.WriteLine(nameof(SendHideProgress));
            NSNotificationCenter.DefaultCenter.PostNotificationName(Notifications.ShowProgressBar, NSNumber.FromBoolean(false));
        }

        private void SetupObservers()
        {
            NSNotificationCenter.DefaultCenter.AddObserver(
                this,
                new Selector("onToggleProgress:"),
                Notifications.ShowProgressBar,
                null);
        }

        [Export("onToggleProgress:")]
        private void OnToggleProgress(NSNotification notification)
        {
            Debug.WriteLine(nameof(OnToggleProgress));
            if (notification.Object is NSNumber showProgressBar)
            {
                ShowProgress(showProgressBar.BoolValue);
            }
        }

        public WindowViewController(IntPtr handle) : base(handle) { }
    }
}
